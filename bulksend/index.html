
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product Table</title>
<style>
    body {
        padding-top: 0px;
        font-family: Arial, sans-serif;
        margin: 40px;
        
    }

    table {
        width: 90%;
        border-collapse: collapse;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 15px;
        border-bottom-right-radius: 10px;
        border-bottom-left-radius: 10px;
        overflow: visible;
        margin: auto;
        background-color: white;
    }

    th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ccc;
    }

    th {
        background-color: #454e55;
        padding: 15px;
        color: white; 
        padding-left: 20px;
        border-right: 1px solid #63686d;
    }

    #productTable thead th:last-child {
    border-right: none;
}


    td[contenteditable="true"]:focus {
        outline: 2px solid #4A90E2;
        background-color: #eef6fc;
        outline-offset: -2px  }

        #sendButton {
    background-image: linear-gradient(to right, #0055aa, #2688ea,#0055aa); /* Adjust these colors to match your needs */
    background-size: 200% 100%;
    animation: gradient-shift 3s linear infinite;
    color: white;
    border: none;
    padding: 15px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-weight: 600;
    font-size: 18px;
    margin-left: auto;
    margin-right: auto;
    margin-top: 30px;
    cursor: pointer;
    border-radius: 40px;
    transition: all 0.9s ease-in;
    box-shadow: rgba(0, 0, 0, 0.04) 0px 1px 1px, rgba(0, 0, 0, 0.04) 0px 2px 2px, rgba(0, 0, 0, 0.04) 0px 4px 4px, rgba(0, 0, 0, 0.04) 0px 8px 8px, rgba(0, 0, 0, 0.04) 0px 16px 16px;
}

@keyframes gradient-shift {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}


#sendButton:hover {
    -webkit-box-shadow: inset 1px 1px 10px #33333365;
   -moz-box-shadow:    inset 1px 1px 10px #33333371;
   box-shadow:         inset 1px 1px 10px #33333367;
   transition: all 0.9s ease;
}


    .valid-product {
  animation: animateBg 10s linear infinite alternate;
  background-image: linear-gradient(45deg, #fff,#fff,#fff, #d9ffe4, #fff, #fff);
  background-size: 100% 1100%;
}

@keyframes animateBg {
  0% { background-position: 0% 0%; }
  100% { background-position: 0% 100%; }
}

#addbuttoncontainer {
    display: flex;
padding-left: 98px
}

#buttoncontainer {
display: flex;
  justify-content: center; /* This centers the child horizontally */
  align-items: center; 
}

    .invalid-product {
        animation: animateBg 10s linear infinite alternate;
  background-image: linear-gradient(45deg, #fff,#fff,#fff, #ffd9d9, #fff, #fff);
  background-size: 100% 1100%;
    }


    td:nth-child(1) {  
 width: 300px;
}


    .delete-btn {
    background-color: red !important;
    color: white;
    left: -40px !important;
    padding: 0; /* Remove padding */
    font-weight: bold;
    font-size: 11px; /* Smaller font size */
    line-height: 1; /* Line height to 1 to prevent increasing height */
    height: 20px; /* Make button height fill the cell */
    width: 20px; /* Set a fixed width */
    border-radius: 50%;
    cursor: pointer;
    display: inline-flex; /* Use flex to vertically and horizontally center content */
    align-items: center; /* Align items vertically */
    justify-content: center; /* Center content horizontally */
    margin: 0; /* Remove any default margins */
    margin-right: 3px;
    border: none;
    animation: ease-in-out 3s;
    vertical-align: middle; /* Keep in line with other inline or inline-block elements */
    overflow: hidden; /* Prevent any part of the button from overflowing the cell */
    }
/* Optional: Hover effect for better user interaction */
.delete-btn:hover {
    -webkit-box-shadow: inset 1px 1px 10px #33333330;
   -moz-box-shadow:    inset 1px 1px 10px #33333330;
   box-shadow:         inset 1px 1px 10px #3333332e;
   animation: ease-in-out 3s;
}

#productTable tbody tr:last-child td {
    border-bottom: none;
}


td .delete-btn {
    float: right; /* Align the button to the right side of the cell */
}

/* Additional adjustments to keep the button within the cell's bounds */
td {
    position: relative; /* Establish a positioning context for absolute positioning */
}

.delete-btn {
    position: absolute; /* Position the button absolutely within the cell */
    right: 0; /* Align it to the right edge of the cell */
    top: 50%; /* Align it to the vertical center */
    transform: translateY(-50%); /* Offset the button by half its height for perfect centering */
    margin: 0; /* Remove any default margins to prevent extra spacing */
    /* Other styles from before... */
}

h1 {
    text-align: center;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    letter-spacing: -1px;
}
h3 {
    text-align: center;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    letter-spacing: -.4px;
}

.animated-text {
    background-image: linear-gradient(45deg,  #003366, #2688ea, #003366); /* Gradient from dark blue to light blue */
    -webkit-background-clip: text;
    color: transparent; /* Make the text color transparent to show the background */
    background-size: 200% 100%; /* Increase the background size for a continuous effect */
    animation: slide 3s linear infinite; /* Apply the animation */
}

@keyframes slide {
    from { background-position: 100% 0; }
    to { background-position: -100% 0; }
}

h4 {
    color: #ccc;
}

#productTable td:first-child {
    position: relative; /* Ensures the dropdown is positioned relative to the cell */
}

ul.dropdown {
    list-style-type: none;
    position: absolute;
    left: 0;
    right: 0;
    z-index: 1000;
    min-width: 400px !important;
    border: 1px solid #ccc;
    background-color: #fff;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    top: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,.2);
    margin-top: 1px; 
}

ul.dropdown li {
    padding: 5px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

ul.dropdown li:hover {
    background-color: #f0f0f0;
}

ul.dropdown li span {
    display: inline-block;
    vertical-align: middle;
}

ul.dropdown li span:first-child {
    font-weight: bold;
    margin-right: 5px;
}

ul.dropdown li span:last-child {
    font-size: smaller;
    color: #555;
}

.dropdown-item {
    padding: 5px;
    cursor: pointer;
    border-bottom: 1px solid #eee; /* Separates items */
    display: flex; /* Use flexbox for layout */
    flex-direction: column; /* Stack code and name vertically */
    align-items: flex-start; /* Aligns content to the left */
}

.dropdown-item:hover {
    background-color: #f0f0f0; /* Highlight item on hover */
}

.product-code {
    font-weight: bold;
    margin-bottom: 2px; /* Space between code and name */
}

.product-name {
    font-size: smaller;
    color: #555;
}

table {
    margin-top: 50px;
    margin-bottom: 20px; /* Adjust based on your design */
}

#addProductButton {
    font-weight: 900;
    color: green;
    background-color: white;
    border: 0px;
    left: 30px !important;
    display: block;
    width: max-content; /* Adjust based on your design */
    padding: 5px 10px; /* Adjust based on your design */
    cursor: pointer;
}

#addProductButton:hover {
    color: rgb(171, 171, 171);
    background-color: white;
    border: 0px;
    left: 30px !important;
    display: block;
    width: max-content; /* Adjust based on your design */
    padding: 5px 10px; /* Adjust based on your design */
    cursor: pointer;
}

#oppidDisplayContainer {
    display: flex;
  justify-content: center; /* This centers the child horizontally */
  align-items: center; 
}


</style>
</head>
<body>
    <h1>Bulk Add <span class="animated-text">Salesforce</span> Products</h1>
    <h3>Copy and Paste from Excel or type a SKU</h3>
    
<table id="productTable">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Quantity</th>
            <th>Product Name</th>
            <th>UnitPrice</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td contenteditable="true"></td>
            <td contenteditable="true"></td>
            <td></td>
            <td contenteditable="true"></td>
        </tr>
    </tbody>
</table>
<div id="addbuttoncontainer">
    <button id="addProductButton">+Product</button>
</div>
<div id="buttoncontainer">
    <h4>Please include qty & price in every row (even if 0)</h4>
    </div>
<div id="buttoncontainer">
<button id="sendButton">Send to Salesforce</button>
</div>

<div id="oppidDisplayContainer">
    <h4>Opportunity ID: <span id="oppidDisplay"></span></h4>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const oppid = getURLParameter('oppid');
    const oppidDisplay = document.getElementById('oppidDisplay');
    oppidDisplay.textContent = oppid || 'No ID provided';

    fetch('Products.json')
        .then(response => response.json())
        .then(data => {
    window.products = {};
    data.forEach(item => {
        // Store product details in an object, including the Price Book Entry ID
        window.products[item['Product Code']] = {
            name: item['Product Name'],
            priceBookEntryId: item['Price Book Entry ID'] // Assuming the JSON includes this field
        };
    });
    const initialSkuCells = document.querySelectorAll('#productTable td:first-child');
    attachAutocompleteListeners(initialSkuCells);
})
        .catch(error => console.error('Error loading product data:', error));

    const table = document.getElementById('productTable');
    table.addEventListener('input', updateProductName);
    table.addEventListener('paste', handlePaste);
    table.addEventListener('click', handleDeleteRow);
    document.getElementById('sendButton').addEventListener('click', sendToSalesforce);

    document.getElementById('addProductButton').addEventListener('click', addNewRow);
});

function getURLParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

function addNewRow() {
    const tbody = document.getElementById('productTable').getElementsByTagName('tbody')[0];
    const newRow = tbody.insertRow(0);
    const cellCount = tbody.rows[tbody.rows.length - 1].cells.length;

    for (let i = 0; i < cellCount; i++) {
        let newCell = newRow.insertCell(i);
        newCell.contentEditable = true;
        if (i === 2) {
            newCell.contentEditable = false;
        }
    }
    attachAutocompleteListeners([newRow.cells[0]]);
}

function attachAutocompleteListeners(cells) {
    cells.forEach(cell => {
        const dropdown = createDropdown();
        cell.appendChild(dropdown);
        cell.addEventListener('input', function(event) {
            updateDropdown(dropdown, event.target.innerText);
            event.stopPropagation();
        });
        cell.addEventListener('focusin', function(event) {
            updateDropdown(dropdown, event.target.innerText);
        });
        cell.addEventListener('focusout', function(event) {
            setTimeout(() => dropdown.style.display = 'none', 200);
        });
    });
}

function createDropdown() {
    let dropdown = document.createElement('ul');
    dropdown.style.listStyleType = 'none';
    dropdown.style.position = 'absolute';
    dropdown.style.zIndex = '1000';
    dropdown.style.border = '1px solid #ccc';
    dropdown.style.backgroundColor = '#fff';
    dropdown.style.width = 'auto';
    dropdown.style.minWidth = '400px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.boxShadow = '0 2px 5px rgba(0,0,0,.2)';
    dropdown.style.marginTop = '8px';
    dropdown.style.marginLeft = '-8px';
    dropdown.style.padding = '0';
    dropdown.style.display = 'none';
    return dropdown;
}

function updateDropdown(dropdown, text) {
    dropdown.innerHTML = '';
    if (text.trim() === "") {
        dropdown.style.display = 'none';
        return;
    }

    const inputText = text.toUpperCase();
    const productsArray = Object.entries(window.products).map(([code, details]) => ({ 
        code, 
        name: details.name,
        upperCode: code.toUpperCase(),
        upperName: details.name.toUpperCase()
    }));
    const matchingProducts = productsArray.filter(product =>
        product.upperCode.includes(inputText) ||
        product.upperName.includes(inputText)
    ).slice(0, 10);

    matchingProducts.forEach(product => {
        let item = document.createElement('li');
        item.classList.add('dropdown-item');
        
        let codeSpan = document.createElement('span');
        codeSpan.textContent = product.code; // Use original case for display
        codeSpan.classList.add('product-code');

        let nameSpan = document.createElement('span');
        nameSpan.textContent = ` - ${product.name}`; // Use original case for display
        nameSpan.classList.add('product-name');

        item.appendChild(codeSpan);
        item.appendChild(nameSpan);
        
        item.addEventListener('click', function() {
            let parentCell = dropdown.closest('td');
            parentCell.innerText = product.code; // Use original case when setting the value
            dropdown.style.display = 'none';
            updateProductName({ target: parentCell });
        });
        
        dropdown.appendChild(item);
        dropdown.style.display = 'block';
    });
}


function updateProductName(e) {
    if (e.target.tagName === 'TD' && e.target.cellIndex === 0) {
        const sku = e.target.textContent.trim();
        const productNameCell = e.target.parentElement.cells[2];
        if (window.products[sku] && window.products[sku].name) {
            productNameCell.textContent = window.products[sku].name;
            productNameCell.className = 'valid-product';
        } else {
            productNameCell.innerHTML = 'Please Manually Add Product in Salesforce <button class="delete-btn">&#10006;</button>';
            productNameCell.className = 'invalid-product';
        }
    }
}


function handlePaste(e) {
    e.preventDefault();
    const clipboardData = e.clipboardData || window.clipboardData;
    const pastedData = clipboardData.getData('Text').trim();
    const rows = pastedData.split('\n');
    const table = document.getElementById('productTable').getElementsByTagName('tbody')[0];
    Array.from(table.rows[0].cells).forEach(cell => cell.textContent = '');
    rows.forEach((rowText, rowIndex) => {
        const rowArray = rowText.split('\t');
        const row = (rowIndex === 0) ? table.rows[0] : table.insertRow();
        rowArray.forEach((cellData, index) => {
            const cell = (rowIndex === 0) ? row.cells[index] : row.insertCell();
            cell.textContent = cellData;
            cell.contentEditable = index !== 2;
        });
        while (row.cells.length < 4) {
            const cell = row.insertCell();
            if (row.cells.length === 4) {
                cell.textContent = '0.00';
                cell.contentEditable = true;
            }
        }
        updateProductName({target: row.cells[0]});
    });
}

document.getElementById('sendButton').addEventListener('click', sendToSalesforce);

function setupOpportunityLink() {
    const oppid = getURLParameter('oppid');
    if (oppid) {
        const salesforceUrl = `https://laxdotcom.my.salesforce.com/${oppid}`;
        const link = document.getElementById('checkOpportunityLink');
        link.href = salesforceUrl; // Set the href attribute of the link to the constructed URL
    } else {
        console.log('No oppid found in URL');
    }
}

function sendToSalesforce() {
    const button = document.getElementById('sendButton');
    button.disabled = true; // Disable the button to prevent multiple submissions
    button.textContent = 'Fueling the ship up...'; // Initial text indicating the start of the process

    // Simulating the delay for each stage
    setTimeout(() => {
        button.textContent = 'Sending products...';

        const oppid = getURLParameter('oppid');
        const rows = document.querySelectorAll('#productTable tbody tr');
        const records = Array.from(rows).map(row => {
            const sku = row.cells[0].textContent.trim();
            const qty = parseInt(row.cells[1].textContent, 10);
            const price = parseFloat(row.cells[3].textContent.replace('$', ''));
            const totalPrice = qty * price; // Calculate TotalPrice
            const productDetails = window.products[sku]; // Retrieve product details from stored data

            return {
                fields: {
                    OpportunityID: oppid,
                    ProductID: sku,
                    Qty: qty,
                    Price: price,
                    ProductName: row.cells[2].textContent,
                    PriceBookEntryID: productDetails ? productDetails.priceBookEntryId : '',
                    TotalPrice: totalPrice // Include TotalPrice in the record
                }
            };
        }).filter(record => record.fields.ProductName !== '');

        fetch('https://omgcleanup.netlify.app/.netlify/functions/sendToAirtable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            button.textContent = 'Sent, please check the Opp';
            setTimeout(() => {
                button.textContent = 'Send to Salesforce';
                button.disabled = false; // Re-enable the button after the process is complete
            }, 2000); // Reset button after 2 seconds
        })
        .catch((error) => {
            console.error('Error:', error);
            button.textContent = 'Error! Try Again';
            setTimeout(() => {
                button.textContent = 'Send to Salesforce';
                button.disabled = false;
            }, 2000);
        });

    }, 2000); // Start the sending process after 2 seconds
}




function handleDeleteRow(e) {
    if (e.target.classList.contains('delete-btn')) {
        e.target.closest('tr').remove();
    }
}

setupOpportunityLink();


</script>

</body>
</html>
